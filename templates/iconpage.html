{% load static %}
<!DOCTYPE html>
<html lang="en">
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

	<title>Редактор | Иконка</title>
	<link href="https://www.jqueryscript.net/css/jquerysctipttop.css" rel="stylesheet" type="text/css">
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

<style type="text/css">
	.shadower:before {
    content: '';
    position:absolute;
    top:0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 40%,rgba(0,0,0,0.7 ) 100%);
    z-index: 1;
}
	.shadower.special:before {
    content: '';
    position:absolute;
    top:0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 0%,rgba(0,0,0,1 ) 100%);
    z-index: 1;
}
	.shadowersmall:before {
    content: '';
    position:absolute;
    top:0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 40%,rgba(0,0,0,0.7 ) 100%);
    z-index: 1;
}
	.shadowersmall.special:before {
    content: '';
    position:absolute;
    top:0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(to bottom, rgba(0,0,0,0) 0%,rgba(0,0,0,1 ) 100%);
    z-index: 1;
}
</style>
</head>

<body>
	<hr>
<div class="container-fluid">
	<nav aria-label="breadcrumb">
	  <ol class="breadcrumb">
	  		<li class="breadcrumb-item"><a href="/editor/" class="link-info" style="color: black">Статьи</a></li>
	  		<li class="breadcrumb-item"><a href="{{ article.get_edit_url }}" class="link-info" style="color: black">{{article.title}}</a></li>
	    	<li class="breadcrumb-item active" aria-current="page">Иконки</li>
	  </ol>
	</nav>

	<div class="row mx-0 px-0 justify-content-center">

		<div class="col-7 col-sm-7 col-md-7 col-lg-7 col-xl-7 col-xxl-7 mx-0 px-0 justify-content-center">
		<!-- LEFT COLUMN and CENTRAL COLUMN -->
			<div id="editors" class="container float mx-0 px-0">
				<div class="row bg-light p-5 mb-1">
					<div class="col-12 m-0 p-0">
					
						<div id="car0" class="row mt-5 justify-content-center">
							<!-- ICONS -->				
						</div>				
					
					</div>	
				</div>
			</div>
			<div class="row my-5">
				<div class="col-12"><button class="btn btn-light btn-block" onclick="sendResult()">Применить</button></div>
			</div>
		</div>



		<div class="col-4 col-sm-4 col-md-4 col-lg-4 col-xl-4 col-xxl-4 ml-5 mr-0 bg-light text-center">
		<!-- RIGHT COLUMN -->
		<div class="row mx-0 p-0 justify-content-left">
		{% for ic in icons %}
			<div id="card{{ic.pk}}" class="card border rounded border-white shadow m-3" style="width: 14rem;">
				<img src="{{ ic.img.url }}" class="card-img-top" onclick="changeFile('{{ic.pk}}');">
				<input type="file" id="chFile{{ic.pk}}" class="inputfile" onchange="updFile(this, '{{ic.pk}}')" style="width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1;" />
										
				<div class="card-body">
					<h5 id="h{{ic.pk}}" class="card-title" onclick="replaceText(this, '{{ic.pk}}', `{{ic.label}}`)">
						{%if ic.label%}{{ic.label}}{%else%}...{%endif%}
					</h5>
					<p id="p{{ic.pk}}" class="card-text" onclick="replaceText(this, '{{ic.pk}}', `{{ic.descr}}`)">{%if ic.descr%}{{ic.descr}}{%else%}...{%endif%}</p>
				</div>

				<div class="card-footer align-center  mx-0 px-0">
					<div class="row justify-content-center">
					
					<button id="delBtn{{ic.pk}}" class="btn btn-outline-danger btn-sm border mt-2 px-1 mx-4" onclick="delIcon('{{ic.pk}}')" name="delBtn" type="submit">Удалить</button>
					<button id="btn{{ic.pk}}" class="btn btn-outline-dark btn-sm border mt-2 px-1 mx-4" onclick="iconToPreview(this, '{{ic.pk}}', '{{ic.label}}', '{{ic.descr}}', '{{ ic.img.url }}')">Просмотр</button>
					</div>
				</div>
			</div>		
		{% endfor %}	

			<form class="row m-3" method="POST" enctype="multipart/form-data" novalidate >
			{% csrf_token %}

				<div class="card border rounded border-white shadow" style="width: 14rem;">
				<input type="file" name="file" id="slFile" onchange="addFile(this)" class="inputfile" style="width: 0.1px; height: 0.1px; opacity: 0; overflow: hidden; position: absolute; z-index: -1;" />
				<label id="loadDescr" class="btn border btn-secondary" for="slFile" style="height: 6rem;"><p class="text-start mt-4">Клик для выбора файла</p></label>
					<div class="card-body">
						<input type="text" class="form-control my-1" name="label" placeholder="Заголовок (необяз.)">
						<input type="text" class="form-control my-1" name="descr" placeholder="Подпись (необяз.)">
						<button id="loadBtn" class="btn btn-success border mt-2" onclick="saveSess()" type="submit" disabled>Добавить</button>
					</div>
				</div>		
			
			</form>
		</div>
		<!-- END RIGHT COLUMN -->
		</div>
	</div>
</div>



<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
<script type="text/javascript">

let PREVIEW = new Array(1).fill(0);

window.onload = function (){
	{%if article.icon %}
		iconToPreview(document.getElementById(`btn{{article.icon.pk}}`), `{{article.icon.pk}}`, `{{article.icon.label}}`,
		 `{{article.icon.descr}}`, `{{article.icon.img.url}}`)
	{% endif %}
	}




function setDefaultSLider(){
	if (STRUCTURE.size === 0){
		document.getElementById("car0").innerHTML = EXMPL;
		return;
	}
	document.getElementById("car0").innerHTML = compouseSlider("newsSlider", STRUCTURE);	
}


function iconToPreview(item, pk, label, descr, source){
	if (PREVIEW.length===4){
		iconFromPreview(document.getElementById(`btn${PREVIEW[0]}`), PREVIEW[0], PREVIEW[1], PREVIEW[2], PREVIEW[3])
	}
	PREVIEW = new Array(pk, label, descr, source); 
	document.getElementById("car0").innerHTML = compouseIcon(label, descr, source);
	document.getElementById(`delBtn${pk}`).disabled = true;
	document.getElementById(`card${pk}`).className = "card border rounded border-secondary bg-light m-3";
	item.outerHTML = `<button id="btn${pk}" class="btn btn-dark btn-sm border mt-2 px-1 mx-4" onclick="iconFromPreview(this, '${pk}', '${label}', '${descr}', '${source}')">Убрать</button>`;
	$('.shadower').on('mouseover', function() {    $(this).toggleClass('special'); });
	$('.shadower').on('mouseout', function() {    $(this).toggleClass('special'); });
	$('.shadowersmall').on('mouseover', function() {    $(this).toggleClass('special'); });
	$('.shadowersmall').on('mouseout', function() {    $(this).toggleClass('special'); });
}

function iconFromPreview(item, pk, label, descr, source){
	PREVIEW = new Array(1).fill(0);
	document.getElementById("car0").innerHTML = "";
	document.getElementById(`delBtn${pk}`).disabled = false;
	document.getElementById(`card${pk}`).className = "card border rounded border-white shadow m-3";
	item.outerHTML = `<button id="btn${pk}" class="btn btn-outline-dark btn-sm border mt-2 px-1 mx-4" onclick="iconToPreview(this, '${pk}', '${label}', '${descr}', '${source}')">Просмотр</button>`;
}


function compouseIcon(label, descr, source){
	return	`
	<div class="row m-0 p-0">
		<div class="card bg-dark text-white shadower">
  			<img class="card-img" src="${source}" alt="Card image" style="max-width: 34rem; max-height: 448px; min-width: 34rem; min-height: 448px;">
  			<div class="card-img-overlay h-100 d-flex flex-column justify-content-end">
  				<h5 class="card-title" style="z-index: 2;">${label}</h5>
    			<p class="card-text" style="z-index: 2;">${descr}</p>
    			<p class="card-text" style="z-index: 2;">Опубликовано 3 минуты назад</p>
  			</div>   
		</div>
	</div>

	<div class="row-col m-0 p-0 justify-content-top">
		<div class="card bg-dark text-white shadowersmall m-0 p-0 ">
  			<img class="card-img" src="${source}" alt="Card image" style="max-width: 17rem; max-height: 224px; min-width: 17rem; min-height: 224px;">
  			<div class="card-img-overlay h-100 d-flex flex-column justify-content-end">
  				<h5 class="card-title" style="z-index: 2;">${label}</h5>
    			<p class="card-text" style="font-size: 80%; z-index: 2;">${descr}</p>
    			<p class="card-text" style="z-index: 2;"><small>Опубликовано 3 минуты назад</small></p>
  			</div>
		</div>
	</div>
			`;
}


////////////////////////////////////


function addFile(item) {
	var fname = item.value.replace(/.*[\/\\]/, '');
	el = document.getElementById("loadDescr").outerHTML = `<label id="loadDescr" class="btn border btn-success" for="file" style="height: 6rem;"><p class="text-start mt-4">${fname}</p></label>`;
	var loadBtn = document.getElementById("loadBtn").disabled = false;
}

function changeFile(pk){
	var elem = document.getElementById(`chFile${pk}`);
	if(elem && document.createEvent) {
      var evt = document.createEvent("MouseEvents");
      evt.initEvent("click", true, false);
      elem.dispatchEvent(evt);
   }
}

function updFile(item, ipk){
   let formData = new FormData();
   formData.append("image", item.files[0]);
   formData.append("ipk", ipk);
   fetch("", {method: "POST", headers:{"X-CSRFToken": '{{ csrf_token }}'}, body: formData}).then(() => location.replace(document.URL));
}


function replaceText(item, ipk, val){
	document.getElementById(item.id).outerHTML = `<input id="${item.id}" type="text" class="form-control my-1" value="${val}">
	<button id="b${item.id}" class="btn btn-info btn-sm border mt-2" type="submit" onclick="updText(this, '${item.id}', '${item.className}', ${ipk})">Обновить</button>`;
}

function updText(btn, itId, itCl, ipk){
	let txt = document.getElementById(itId);
	let val = txt.value;
	txt.outerHTML = (itCl==="card-title")? `<h5 id="${itId}" class="card-title" onclick="replaceText(this, '${ipk}', '${val}')">${(val==="")? '...': val}</h5>` : `<p id="${itId}" class="card-text" onclick="replaceText(this, '${ipk}', '${val}')">${(val==="")? '...': val}</p>`;
	btn.parentNode.removeChild(btn);
	let formData = new FormData();
	formData.append("ipk", ipk);
	formData.append("class", itCl);  // title or text to update
	formData.append("val", val);
	fetch("", {method: "POST", headers:{"X-CSRFToken": '{{ csrf_token }}'}, body: formData}).then(() => location.replace(document.URL));
}

function delIcon(pk){
	let formData = new FormData();
	formData.append("delIcon", pk);
	fetch("", {method: "POST", headers:{"X-CSRFToken": '{{ csrf_token }}'}, body: formData}).then(() => location.replace(document.URL));
}


function sendResult(){
	let formData = new FormData();
	(PREVIEW.length===4)? formData.append("iconStruct", JSON.stringify(PREVIEW[0])): formData.append("iconStruct", JSON.stringify(null));
	fetch("", {method: "POST", headers:{"X-CSRFToken": '{{ csrf_token }}'}, body: formData}).then(() => location.replace(document.URL));
}


</script>
</body>
</html>
